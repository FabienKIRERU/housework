image: edbizarro/gitlab-ci-pipeline-php:8.2

# D√©finition des √©tapes
stages:
  - build
  - test

# Cache pour acc√©l√©rer les prochaines ex√©cutions
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

# √âtape 1 : Installation (Build)
setup:
  stage: build
  tags:        
    - docker
  script:
    - echo "üõ†Ô∏è Installation des d√©pendances..."
    # On installe les librairies syst√®me requises par Laravel (Zip, XML, etc.)
    - apt-get update -y && apt-get install -y openssl zip unzip git libonig-dev libxml2-dev libsqlite3-dev
    # On installe les extensions PHP
    - docker-php-ext-install mbstring pdo pdo_mysql xml
    # Installation de Composer
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
    - cp .env.example .env
    - php artisan key:generate
  artifacts:
    # On transmet le dossier vendor et le .env √† l'√©tape suivante
    paths:
      - vendor/
      - .env
    expire_in: 30 mins

# √âtape 2 : Tests (Test)
unit_test:
  stage: test
  tags:
    - docker
  script:
    - echo "üß™ Lancement des tests..."
    # Cr√©ation du fichier SQLite
    - touch database/database.sqlite
    # Migration de la base de donn√©es
    - php artisan migrate --force
    # Ex√©cution des tests
    - php artisan test
  # ICI : On force Laravel √† utiliser SQLite au lieu de MySQL
  variables:
    DB_CONNECTION: sqlite
    DB_DATABASE: database/database.sqlite