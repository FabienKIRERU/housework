image: php:8.4

# D√©finition des √©tapes
stages:
  - build
  - test

# Cache pour acc√©l√©rer les prochaines ex√©cutions
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

# √âtape 1 : Installation (Build)
setup:
  stage: build
  tags:        
    - docker
  script:
    - echo "üõ†Ô∏è Installation des d√©pendances optimis√©e..."
    # 1. On installe juste git et unzip (tr√®s l√©ger)
    - apt-get update -y && apt-get install -y unzip git
    
    # 2. L'ASTUCE : On t√©l√©charge un script qui installe les extensions PHP en 2 secondes sans compiler
    # Cela √©vite le crash m√©moire sur ton VPS
    - curl -sSLf -o /usr/local/bin/install-php-extensions https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions
    - chmod +x /usr/local/bin/install-php-extensions
    - install-php-extensions pdo pdo_mysql xml mbstring zip sqlite3

    # 3. Installation de Composer
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
    
    # 4. Config Laravel
    - cp .env.example .env
    - php artisan key:generate
  
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 30 mins

# √âtape 2 : Tests (Test)
unit_test:
  stage: test
  tags:
    - docker
  script:
    - echo "üß™ Lancement des tests..."
    # Cr√©ation du fichier SQLite
    - touch database/database.sqlite
    # Migration de la base de donn√©es
    - php artisan migrate --force
    # Ex√©cution des tests
    - php artisan test
  # ICI : On force Laravel √† utiliser SQLite au lieu de MySQL
  variables:
    DB_CONNECTION: sqlite
    DB_DATABASE: database/database.sqlite

    